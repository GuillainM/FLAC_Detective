============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-7.4.4, pluggy-1.6.0 -- C:\Users\loutr\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\loutr\Dropbox\Perso\Flac_Detective
configfile: pyproject.toml
plugins: anyio-4.11.0, cov-4.1.0, mock-3.15.1
collecting ... collected 19 items

tests/test_quality.py::TestQualityAnalysis::test_detect_clipping_no_clipping PASSED [  5%]
tests/test_quality.py::TestQualityAnalysis::test_detect_clipping_with_clipping PASSED [ 10%]
tests/test_quality.py::TestQualityAnalysis::test_detect_clipping_light PASSED [ 15%]
tests/test_quality.py::TestQualityAnalysis::test_detect_clipping_stereo PASSED [ 21%]
tests/test_quality.py::TestQualityAnalysis::test_detect_dc_offset_no_offset PASSED [ 26%]
tests/test_quality.py::TestQualityAnalysis::test_detect_dc_offset_with_offset PASSED [ 31%]
tests/test_quality.py::TestQualityAnalysis::test_detect_dc_offset_stereo PASSED [ 36%]
tests/test_quality.py::TestQualityAnalysis::test_detect_corruption_valid_file PASSED [ 42%]
tests/test_quality.py::TestQualityAnalysis::test_detect_corruption_read_error PASSED [ 47%]
tests/test_quality.py::TestQualityAnalysis::test_detect_corruption_empty_file PASSED [ 52%]
tests/test_quality.py::TestQualityAnalysis::test_detect_corruption_nan_values PASSED [ 57%]
tests/test_quality.py::TestQualityAnalysis::test_detect_silence_no_issue FAILED [ 63%]
tests/test_quality.py::TestQualityAnalysis::test_detect_silence_leading FAILED [ 68%]
tests/test_quality.py::TestQualityAnalysis::test_detect_true_bit_depth_real_24bit FAILED [ 73%]
tests/test_quality.py::TestQualityAnalysis::test_detect_true_bit_depth_fake_24bit FAILED [ 78%]
tests/test_quality.py::TestQualityAnalysis::test_detect_upsampling_no_issue PASSED [ 84%]
tests/test_quality.py::TestQualityAnalysis::test_detect_upsampling_96k_fake PASSED [ 89%]
tests/test_quality.py::TestQualityAnalysis::test_analyze_audio_quality_complete PASSED [ 94%]
tests/test_quality.py::TestQualityAnalysis::test_analyze_audio_quality_corrupted_file PASSED [100%]

================================== FAILURES ===================================
______________ TestQualityAnalysis.test_detect_silence_no_issue _______________

self = <test_quality.TestQualityAnalysis object at 0x0000021AF14011D0>

    def test_detect_silence_no_issue(self):
        """VÚrifie la dÚtection sans silence anormal."""
        data = np.random.rand(44100 * 5)  # 5 secondes de bruit
        result = detect_silence(data, 44100)
>       assert result["has_silence_issue"] is False
E       assert np.False_ is False

data       = array([0.37890131, 0.18094785, 0.52762982, ..., 0.01614885, 0.92049056,
       0.14936904], shape=(220500,))
result     = {'has_silence_issue': np.False_, 'issue_type': 'none', 'leading_silence_sec': np.float64(0.0), 'trailing_silence_sec': np.float64(0.0)}
self       = <test_quality.TestQualityAnalysis object at 0x0000021AF14011D0>

tests\test_quality.py:146: AssertionError
_______________ TestQualityAnalysis.test_detect_silence_leading _______________

self = <test_quality.TestQualityAnalysis object at 0x0000021AF1401550>

    def test_detect_silence_leading(self):
        """VÚrifie la dÚtection de silence au dÚbut."""
        # 3 secondes de silence puis 2 secondes de bruit
        silence = np.zeros(44100 * 3)
        noise = np.random.rand(44100 * 2)
        data = np.concatenate([silence, noise])
    
        result = detect_silence(data, 44100)
>       assert result["has_silence_issue"] is True
E       assert np.True_ is True

data       = array([0.        , 0.        , 0.        , ..., 0.79727339, 0.11363167,
       0.56041058], shape=(220500,))
noise      = array([0.08605163, 0.83606341, 0.37316897, ..., 0.79727339, 0.11363167,
       0.56041058], shape=(88200,))
result     = {'has_silence_issue': np.True_, 'issue_type': 'leading', 'leading_silence_sec': np.float64(3.0), 'trailing_silence_sec': np.float64(0.0)}
self       = <test_quality.TestQualityAnalysis object at 0x0000021AF1401550>
silence    = array([0., 0., 0., ..., 0., 0., 0.], shape=(132300,))

tests\test_quality.py:156: AssertionError
__________ TestQualityAnalysis.test_detect_true_bit_depth_real_24bit __________

self = <test_quality.TestQualityAnalysis object at 0x0000021AF138D710>

    def test_detect_true_bit_depth_real_24bit(self):
        """VÚrifie un vrai fichier 24-bit."""
        # Valeurs alÚatoires non multiples de 1/32768
        data = np.random.rand(1000).astype('float32')
        result = detect_true_bit_depth(data, 24)
    
>       assert result["is_fake_high_res"] is False
E       assert np.False_ is False

data       = array([3.51086825e-01, 7.07951069e-01, 9.19392347e-01, 2.86822170e-02,
       6.43455446e-01, 1.90452889e-01, 1.750198...82285e-01, 8.60857189e-01,
       5.96364617e-01, 3.18415761e-01, 1.85315549e-01, 6.64305210e-01],
      dtype=float32)
result     = {'details': 'True 24-bit', 'estimated_depth': 24, 'is_fake_high_res': np.False_}
self       = <test_quality.TestQualityAnalysis object at 0x0000021AF138D710>

tests\test_quality.py:166: AssertionError
__________ TestQualityAnalysis.test_detect_true_bit_depth_fake_24bit __________

self = <test_quality.TestQualityAnalysis object at 0x0000021AF1286ED0>

    def test_detect_true_bit_depth_fake_24bit(self):
        """VÚrifie un faux fichier 24-bit (16-bit padding)."""
        # CrÚer des valeurs 16-bit (multiples de 1/32768)
        int_values = np.random.randint(-32768, 32767, 1000)
        data = int_values / 32768.0
        data = data.astype('float32')
    
        result = detect_true_bit_depth(data, 24)
    
>       assert result["is_fake_high_res"] is True
E       assert np.True_ is True

data       = array([ 9.22241211e-02, -4.29321289e-01,  6.57104492e-01, -2.64465332e-01,
        9.42810059e-01, -5.03997803e-01, -4...e-01,  1.95617676e-01,
        9.83795166e-01,  2.99377441e-01,  2.82470703e-01, -6.92932129e-01],
      dtype=float32)
int_values = array([  3022, -14068,  21532,  -8666,  30894, -16515, -14032,  16328,
        30421,  16472, -24403, -26974, -13013, ...013, -23705,  14698,  -6716,
       -26814, -11631,   3398,   6410,  32237,   9810,   9256, -22706],
      dtype=int32)
result     = {'details': '24-bit file contains only 16-bit data', 'estimated_depth': 16, 'is_fake_high_res': np.True_}
self       = <test_quality.TestQualityAnalysis object at 0x0000021AF1286ED0>

tests\test_quality.py:178: AssertionError

---------- coverage: platform win32, python 3.13.7-final-0 -----------
Name                                            Stmts   Miss Branch BrPart   Cover   Missing
--------------------------------------------------------------------------------------------
src\flac_detective\__init__.py                      5      0      0      0 100.00%
src\flac_detective\analysis\__init__.py             2      0      0      0 100.00%
src\flac_detective\analysis\analyzer.py            22     11      0      0  50.00%   24, 36-85
src\flac_detective\analysis\metadata.py            33     25      2      0  22.86%   22-37, 53-90
src\flac_detective\analysis\quality.py            123     19     50     12  82.08%   87, 89, 167, 177, 195, 199, 269->277, 275, 323-326, 332-335, 338-340, 358->357, 362
src\flac_detective\analysis\scoring.py             67     59     32      0   8.08%   38-77, 94-111, 125-134, 149-160
src\flac_detective\analysis\spectrum.py            84     72     24      0  11.11%   31-92, 111-168, 183-197
src\flac_detective\analyzer.py                      2      2      0      0   0.00%   6-8
src\flac_detective\config.py                       33      0      0      0 100.00%
src\flac_detective\main.py                        126    126     36      0   0.00%   13-238
src\flac_detective\repair.py                        3      3      0      0   0.00%   6-9
src\flac_detective\repair\__init__.py               2      2      0      0   0.00%   7-9
src\flac_detective\repair\__main__.py              34     34     12      0   0.00%   3-76
src\flac_detective\repair\encoding.py              22     22      4      0   0.00%   3-74
src\flac_detective\repair\fixer.py                112    112     20      0   0.00%   3-229
src\flac_detective\repair\metadata.py              49     49     14      0   0.00%   3-108
src\flac_detective\reporter.py                      2      2      0      0   0.00%   6-8
src\flac_detective\reporting\__init__.py            3      0      0      0 100.00%
src\flac_detective\reporting\reporter.py          139    123     20      0  10.06%   31-35, 45-55, 64-96, 106-178, 187-276
src\flac_detective\reporting\statistics.py         20     17      2      0  13.64%   15-52, 95
src\flac_detective\reporting\styles.py             13      5      4      0  47.06%   50-55
src\flac_detective\reporting\text_reporter.py     103     89     34      0  10.22%   18, 29-31, 42, 54-64, 75-82, 93-100, 109-226
src\flac_detective\tracker.py                      39     24      4      0  34.88%   21-24, 32-39, 50-55, 66, 74-76, 84, 92, 100
src\flac_detective\utils.py                        10      4      0      0  60.00%   38-41
--------------------------------------------------------------------------------------------
TOTAL                                            1048    800    258     12  21.90%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ===========================
FAILED tests/test_quality.py::TestQualityAnalysis::test_detect_silence_no_issue
FAILED tests/test_quality.py::TestQualityAnalysis::test_detect_silence_leading
FAILED tests/test_quality.py::TestQualityAnalysis::test_detect_true_bit_depth_real_24bit
FAILED tests/test_quality.py::TestQualityAnalysis::test_detect_true_bit_depth_fake_24bit
======================== 4 failed, 15 passed in 13.55s ========================
